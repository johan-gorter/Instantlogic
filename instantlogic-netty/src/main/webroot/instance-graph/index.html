<!DOCTYPE html>
<html>
  <head>
    <title>Instance Graph</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no">
    <script src="zepto.js"></script>
    <script src="/webjars/d3js/3.4.6/d3.js"></script>
    <script src="element.js"></script>
    <script src="fragment.js"></script>
    <script src="channel.js"></script>
    <script src="engine.js"></script>
    <script src="graph.js"></script>
    <script src="presence-fragment-library.js"></script>
    <script src="basic-fragment-library.js"></script>
    <link rel="stylesheet" href="normalize.css" />
    <link rel="stylesheet" href="instance-graph.css" />
    <link rel="stylesheet" href="presence.css" />
    <link rel="stylesheet" href="basic.css" />
  </head>
  <body>
    <div class="instance-graph"></div>
    <div id="place"></div>
    <div id="presence"></div>
    <script>

      var travelerId = "" + Math.floor(Math.random() * 100000000000);
      
      var applicationMatch = /application=([^&]*)/g.exec(location.search);
      if (!applicationMatch) throw new Error('Missing application querystring parameter');
      var caseMatch = /case=([^&]*)/g.exec(location.search);
      if (!caseMatch) throw new Error('Missing case querystring parameter');

      document.title = caseMatch[1] + " - " + applicationMatch[1] + ", instances graph";

      var channel = window.createChannel(applicationMatch[1], caseMatch[1], travelerId);
      channel.enableAutoRefresh();
      var instanceGraph = window.createInstanceGraph($(".instance-graph"), "theGraph", channel);
      var engine = window.createEngine(applicationMatch[1], caseMatch[1], travelerId, channel, $("#presence"), $("#place"), {});
      
      if (window.location.hash) {
        instanceGraph.showInstance(window.location.hash.substr(1));
	    instanceGraph.expandFirstLevel();
	    var enterLocation = /location=([^&]*)/g.exec(window.location.hash);
	    engine.enter(enterLocation[1]);
      }
      window.onhashchange = function() {
        instanceGraph.showInstance(window.location.hash.substr(1));
      }
    </script>
  </body>
</html>
